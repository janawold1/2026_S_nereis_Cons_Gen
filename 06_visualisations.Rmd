# Visualising Results
## Overview
In this `.Rmd` we are visualising many of the outputs from the SNP- and SV-based population analyses for fairy tern populations in Western Australian and Aotearoa New Zealand.   
```{r setup, include=FALSE}
setwd("C:/Users/Jana/Git_Repos/2024_MolEcol_ConsGen_Special_Issue/data/")

library(tidyr)
library(ggplot2)
library(dplyr)
library(mclust)
#install.packages("devtools")
#devtools::install_github("G-Thomson/Manu")
library(Manu)

pal <- get_pal("Kotare")
get_pal("Kotare")
print_pal(pal)
```
## Runs of Homozygosity
Create a one-column file (e.g., scat_rohs.txt) with ROH sizes across all samples. 
```{r ROH clusters, include=FALSE}
roh <- read.csv("ROHs.tsv", sep = "\t", header = TRUE)
nzroh <- filter(roh, Population == "NZ") %>% select(ROH_len)
names(nzroh) <- NULL
nzroh_clust <- Mclust(nzroh)
nzroh_bic <- mclustBIC(nzroh)

auroh <- filter(roh, Population == "AU") %>% select(ROH_len)
names(auroh) <- NULL
auroh_clust <- Mclust(auroh)
auroh_bic <- mclustBIC(auroh)

summary(nzroh_clust, parameter=TRUE)
summary(nzroh_bic, parameter=TRUE)
summary(auroh_clust, parameter=TRUE)
summary(auroh_bic, parameter=TRUE)

x <- seq(0, 35000000, length = 1000)

nzstern1 <- dnorm(x, mean=nzroh_clust$parameters$mean[1], sd=sqrt(nzroh_clust$parameters$variance$sigmasq[1]))
nzstern2 <- dnorm(x, mean=nzroh_clust$parameters$mean[2], sd=sqrt(nzroh_clust$parameters$variance$sigmasq[2]))
nzstern3 <- dnorm(x, mean=nzroh_clust$parameters$mean[3], sd=sqrt(nzroh_clust$parameters$variance$sigmasq[3]))

austern1 <- dnorm(x, mean=auroh_clust$parameters$mean[1], sd=sqrt(auroh_clust$parameters$variance$sigmasq[1]))
austern2 <- dnorm(x, mean=auroh_clust$parameters$mean[2], sd=sqrt(auroh_clust$parameters$variance$sigmasq[2]))
austern3 <- dnorm(x, mean=auroh_clust$parameters$mean[3], sd=sqrt(auroh_clust$parameters$variance$sigmasq[3]))
```
Here we plot the clustering of ROHs in tara iti.  

```{r nz clust plots, include=FALSE}
png("plots/Tara_iti_ROH_BIC.png")
plot(nzroh_bic)
dev.off()

png("plots/Tara_iti_ROH_frequency.png")
hist(nzroh_clust$data, breaks=132, main="Distribution of ROH for tara iti", xlab="Number of base pairs")
lines(x, (nzstern1*1100000000), col="red")
lines(x, (nzstern2*1100000000), col="blue")
lines(x, (nzstern3*1100000000), col="green")
legend("topright", title="Gaussian groups", legend=c("Short","Medium","Long"), lty=c(1,1,1), col=c("red", "blue", "green"))
dev.off()

png("plots/Tara_iti_ROH_sizes.png")
hist(nzroh_clust$data, breaks = 132, main = "Distribution of ROH for S. nereis davisae", xlab = "Number of base pairs")
abline(v = 200000, lty = 5, col = "red")
abline(v = 700000, lty = 4, col = "blue")
legend("topright", title="ROH boundries", legend=c("Short-Medium break","Medium-Long break"), lty=c(5,4), col=c("red", "blue"))
dev.off()

png(filename="plots/Tara_iti_ROH_clusters.png")
plot(x, nzstern1, col = "red", type = "l", main = "ROH length distributions for S. nereis davisae",
     xlab = "Number of base pairs", ylab = "", yaxt = "n")
lines(x, (nzstern2), col = "blue")
lines(x, (nzstern3), col = "green")
legend("topright", title = "Gaussian groups", legend = c("Short", "Medium", "Long"), lty = c(1,1,1), col = c("red", "blue", "green"))
dev.off()
```

```{r au clust plots, include=FALSE}
png(filename = "plots/Australia_ROH_BIC.png")
plot(auroh_bic)
dev.off()

png(filename = "plots/Australia_ROH_frequency.png")
hist(auroh_clust$data, breaks=132, main="Distribution of ROH for Australian fairy tern", xlab="Number of base pairs")
lines(x, (austern1*1100000000), col="red")
lines(x, (austern2*1100000000), col="blue")
lines(x, (austern3*1100000000), col="green")
legend("topright", title="Gaussian groups", legend=c("Short","Medium","Long"), lty=c(1,1,1), col=c("red", "blue", "green"))
dev.off()

png(filename = "plots/Australia_ROH_sizes.png")
hist(auroh_clust$data, breaks = 132, main = "Distribution of ROH for S. nereis nereis", xlab = "Number of base pairs")
abline(v = 200000, lty = 5, col = "red")
abline(v = 700000, lty = 4, col = "blue")
legend("topright", title="ROH boundries", legend=c("Short-Medium break","Medium-Long break"), lty=c(5,4), col=c("red", "blue"))
dev.off()

png(filename="plots/Australia_ROH_clusters.png")
plot(x, austern1, col = "red", type = "l", main = "ROH length distributions for S. nereis davisae",
     xlab = "Number of base pairs", ylab = "", yaxt = "n")
lines(x, (austern2), col = "blue")
lines(x, (austern3), col = "green")
legend("topright", title = "Gaussian groups", legend = c("Short", "Medium", "Long"), lty = c(1,1,1), col = c("red", "blue", "green"))
dev.off()
```
Temporary ROH Stats
```{r ROH plots and summary, include=FALSE}
library(patchwork)

head(roh)
filter(roh, Population == 'AU') %>% select(ROH_len) %>% summary()
filter(roh, Population == 'NZ') %>% select(ROH_len) %>% summary()

roh$ROH_class <- factor(roh$ROH_class, level=c('short_ROH', 'medium_ROH', 'long_ROH'))

ROH_bar_data <- roh %>%
    group_by(Sample, ROH_class, Population) %>%
    tally %>%
    group_by(ROH_class, Population) %>%
    summarise_at(vars(n), list(name = mean))

ROH_point_data <- roh %>%
    group_by(Sample, ROH_class, Population) %>%
    tally

ROH_bar_plot <- ggplot(ROH_bar_data, aes(x = ROH_class, y = name, fill = Population)) +
    geom_bar(alpha = 0.7, position = "dodge", stat = "identity") +
    theme_light() +
    ylim(0,800) +
    labs(x = "ROH Class", y = "ROH Count") +
    scale_fill_manual(values = c("AU" = "#E5BF86","NZ" = "#287DAB")) 
    theme(panel.background = element_rect(fill = "transparent"))


ROH_point_plot <- ggplot(ROH_point_data, aes(x = ROH_class, y = n, color = Population)) +
    geom_point(size = 2.5, position = position_dodge(width = 0.9)) +
    theme_light() +
    ylim(0, 800) +
    labs(x = "ROH Class", y = "ROH Count") +
    scale_color_manual(values = c("AU" = "#E5BF86","NZ" = "#287DAB")) 
    theme(panel.background = element_rect(fill = "transparent"))

patch_design <- c(area(1, 1, 1, 1),
                  area(1, 1, 1, 1))

ROH_bar_plot + ROH_point_plot
ggsave( 'plots/average_ROH_length.png', ROH_size_plot, device = "png")
```
MORE ROH PLOTTING
```{r ROH Distribution by length, include=FALSE}
roh %>%
    groupby(Sample) %>%
    ggplot(aes(x = ROH_class)) +
        geom_bar()
```